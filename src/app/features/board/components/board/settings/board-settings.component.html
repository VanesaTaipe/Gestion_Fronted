<div class="max-w-5xl mx-auto">
  <h2 class="text-2xl font-bold text-gray-900 mb-6">Configuraci√≥n del Proyecto</h2>
  
  <!-- Informaci√≥n del Proyecto -->
  <div class="bg-white rounded-xl shadow p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-gray-900">Informaci√≥n del Proyecto</h3>
      <!-- ‚úÖ Solo l√≠deres pueden editar -->
      <button 
        *ngIf="isLeader"
        (click)="editingProject = !editingProject"
        class="px-4 py-2 text-sm bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg">
        {{ editingProject ? 'Cancelar' : 'Editar' }}
      </button>
    </div>

    <!-- ‚úÖ Formulario solo visible para l√≠deres -->
    <form [formGroup]="projectForm" *ngIf="editingProject && isLeader; else projectInfo" (ngSubmit)="updateProject()">
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo del proyecto</label>
          <input 
            type="text"
            formControlName="nombre"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
            placeholder="Nombre del proyecto">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Descripci√≥n</label>
          <textarea 
            formControlName="descripcion"
            rows="3"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
            placeholder="Descripci√≥n del proyecto"></textarea>
        </div>

        <div class="flex justify-end gap-3">
          <button 
            type="button"
            (click)="cancelEditProject()"
            class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">
            Cancelar
          </button>
          <button 
            type="submit"
            [disabled]="projectForm.invalid || updatingProject"
            class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg disabled:opacity-50">
            {{ updatingProject ? 'Guardando...' : 'Guardar Cambios' }}
          </button>
        </div>
      </div>
    </form>

    <ng-template #projectInfo>
      <div class="space-y-3">
        <div>
          <p class="text-sm text-gray-600">Nombre</p>
          <p class="text-base font-medium text-gray-900">{{ projectName }}</p>
        </div>
        <div *ngIf="projectDescription">
          <p class="text-sm text-gray-600">Descripci√≥n</p>
          <p class="text-base text-gray-900 descripcion-proyecto">{{ projectDescription }}</p>
        </div>
      </div>
    </ng-template>
  </div>

  <!-- ‚úÖ Gesti√≥n de Miembros - Solo visible para l√≠deres -->
  <div *ngIf="isLeader" class="bg-white rounded-xl shadow p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-gray-900">Gesti√≥n de miembros</h3>
      <button 
        (click)="openInviteDialog()"
        class="px-4 py-2 text-sm bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
        </svg>
        Invitar nuevo miembro
      </button>
    </div>

    <!-- Buscador de usuarios existentes -->
    <div class="mb-6">
      <h4 class="text-sm font-semibold text-gray-700 mb-3">Buscar y agregar usuario existente</h4>
      
      <form [formGroup]="projectForm">
        <div class="autocomplete-wrapper">
          <input 
            type="text"
            class="custom-input"
            formControlName="searchUser"
            placeholder="Buscar por email o nombre de usuario"
            [matAutocomplete]="auto">
          <mat-icon class="search-icon">search</mat-icon>
        </div>
        
        <p class="text-xs text-gray-500 mt-2">
          üí° Escribe al menos 3 caracteres para comenzar la b√∫squeda
        </p>
        
        <mat-autocomplete 
          #auto="matAutocomplete"
          (optionSelected)="addMemberFromSearch($event.option.value)"
          [displayWith]="displayUser">
          <mat-option 
            *ngFor="let user of filteredUsers$ | async" 
            [value]="user">
            <div class="user-option">
              <div class="user-avatar">
                {{ getUserInitials(user) }}
              </div>
              <div class="user-info">
                <div class="user-name">{{ user.username }}</div>
                <div class="user-email">{{ user.email }}</div>
              </div>
            </div>
          </mat-option>
          
          <!-- Cargando -->
          <mat-option *ngIf="isSearchingUsers" disabled>
            <div class="no-results">
              <svg class="animate-spin h-5 w-5 mx-auto mb-2" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
              </svg>
              Buscando usuarios...
            </div>
          </mat-option>
          
          <!-- Sin resultados -->
          <mat-option *ngIf="(filteredUsers$ | async)?.length === 0 && !isSearchingUsers && projectForm.get('searchUser')?.value?.length >= 3" disabled>
            <div class="no-results">
              No se encontraron usuarios con ese criterio
            </div>
          </mat-option>
        </mat-autocomplete>
      </form>
    </div>

    <!-- MIEMBROS PENDIENTES CON SELECTOR DE ROL -->
    <div *ngIf="miembrosPendientes.length > 0" class="space-y-3 mb-6">
      <h4 class="text-sm font-semibold text-gray-700 mb-3">
        Miembros pendientes de confirmar ({{ miembrosPendientes.length }})
      </h4>
      
      <div *ngFor="let miembro of miembrosPendientes" class="pending-chip">
        <div class="chip-avatar pending">
          {{ miembro.username.charAt(0).toUpperCase() }}
        </div>
        
        <div class="chip-info">
          <span class="chip-name">{{ miembro.username }}</span>
          <span class="chip-email">{{ miembro.email }}</span>
        </div>

        <!-- SELECTOR DE ROL -->
        <div class="flex items-center gap-2">
          <label class="text-xs text-gray-600">Rol:</label>
          <select 
            [(ngModel)]="miembro.rol_temporal"
            [ngModelOptions]="{standalone: true}"
            class="px-3 py-1 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500">
            <option [value]="2">Miembro</option>
            <option [value]="1">L√≠der</option>
          </select>
        </div>

        <!-- Botones -->
        <div class="flex gap-2">
          <button 
            (click)="confirmarMiembro(miembro)"
            class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm">
            Confirmar
          </button>
          <button 
            (click)="cancelarMiembro(miembro)"
            class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-lg text-sm">
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <!-- Lista de miembros actuales -->
    <div class="space-y-3">
      <h4 class="text-sm font-semibold text-gray-700 mb-3">Miembros actuales ({{ projectMembers.length }})</h4>
      
      <div *ngFor="let member of projectMembers" 
           class="member-chip"
           [class.admin-chip]="getRolId(member.rol) === 1">
        <div class="chip-avatar">
          {{ member.nombre.charAt(0).toUpperCase() }}
        </div>
        
        <div class="chip-info">
          <span class="chip-name">{{ member.nombre }}</span>
          <span class="chip-email">{{ member.email }}</span>
        </div>

        <span class="role-badge">
          {{ getRolId(member.rol) === 1 ? 'L√≠der' : 'Miembro' }}
        </span>

        <!-- Bot√≥n cambiar rol (solo si soy l√≠der, y si es creador debe haber otros l√≠deres) -->
        <button 
          *ngIf="isLeader && (!member.es_creador || (member.es_creador && hasMultipleLeaders()))"
          mat-icon-button
          (click)="toggleMemberRole(member)"
          class="role-toggle"
          title="Cambiar rol">
          <mat-icon>swap_horiz</mat-icon>
        </button>

        <!-- Bot√≥n eliminar (solo si soy l√≠der y el miembro NO es creador) -->
        <button 
          *ngIf="isLeader && !member.es_creador"
          mat-icon-button
          (click)="removeMember(member)"
          class="remove-btn"
          title="Eliminar miembro">
          <mat-icon>close</mat-icon>
        </button>

        <!-- Badge de creador -->
        <span *ngIf="member.es_creador" class="creator-badge">
          Creador
        </span>
      </div>

      <p *ngIf="projectMembers.length === 0" class="text-center text-gray-500 py-8">
        No hay miembros en este proyecto
      </p>
    </div>
  </div>

  <!-- ‚úÖ Lista de miembros - Vista para MIEMBROS (solo lectura) -->
  <div *ngIf="!isLeader" class="bg-white rounded-xl shadow p-6 mb-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">Miembros del proyecto</h3>
    
    <div class="space-y-3">
      <div *ngFor="let member of projectMembers" 
           class="member-chip"
           [class.admin-chip]="getRolId(member.rol) === 1">
        <div class="chip-avatar">
          {{ member.nombre.charAt(0).toUpperCase() }}
        </div>
        
        <div class="chip-info">
          <span class="chip-name">{{ member.nombre }}</span>
          <span class="chip-email">{{ member.email }}</span>
        </div>

        <span class="role-badge">
          {{ getRolId(member.rol) === 1 ? 'L√≠der' : 'Miembro' }}
        </span>

        <span *ngIf="member.es_creador" class="creator-badge">
          Creador
        </span>
      </div>

      <p *ngIf="projectMembers.length === 0" class="text-center text-gray-500 py-8">
        No hay miembros en este proyecto
      </p>
    </div>
  </div>

  <!-- ‚úÖ Zona de Peligro - Solo visible para l√≠deres -->
  <div *ngIf="isLeader" class="bg-white rounded-xl shadow border-2 border-red-200 p-6 mb-6">
    <h3 class="text-lg font-semibold text-red-600 mb-4">Zona de peligro</h3>
    <p class="text-sm text-gray-600 mb-4">
      Una vez que elimines el proyecto, no hay vuelta atr√°s. Por favor, ten cuidado.
    </p>
    <button 
      (click)="deleteProject()"
      class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors">
      Eliminar proyecto
    </button>
  </div>

  <!-- ‚úÖ Salir del proyecto - Visible para TODOS -->
  <div class="bg-white rounded-xl shadow border-2 border-yellow-200 p-6">
    <div class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center">
          <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
          </svg>
        </div>
        <div>
          <h4 class="font-semibold text-gray-900">Salir del proyecto</h4>
          <p class="text-sm text-gray-600">
            <span *ngIf="isLeader">Como l√≠der, deber√°s asignar un nuevo l√≠der si eres el √∫nico.</span>
            <span *ngIf="!isLeader">Dejar√°s de tener acceso a este proyecto.</span>
          </p>
        </div>
      </div>
      <button 
        (click)="openLeaveModal()"
        class="px-6 py-3 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-medium transition-colors">
        Salir del Proyecto
      </button>
    </div>
  </div>

  <!-- Modal: Salir del proyecto (directo) -->
  <div *ngIf="showLeaveModal && !requiresNewLeader" 
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/40"
      (click)="closeLeaveModal()">
    <div class="bg-white w-[480px] max-w-[95vw] rounded-2xl shadow-xl p-6" 
        (click)="$event.stopPropagation()">
      <h3 class="text-xl font-bold text-gray-900 mb-4">¬øSalir del proyecto?</h3>
      
      <p class="text-gray-600 mb-6">
        <span *ngIf="isLeader">
          Est√°s a punto de salir del proyecto. Como hay otros l√≠deres, el proyecto continuar√° sin ti.
        </span>
        <span *ngIf="!isLeader">
          Est√°s a punto de salir del proyecto. Perder√°s acceso a todas las tareas y columnas.
        </span>
      </p>

      <div class="flex justify-end gap-3">
        <button 
          type="button"
          (click)="closeLeaveModal()"
          class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">
          Cancelar
        </button>
        <button 
          type="button"
          (click)="confirmLeaveProject()"
          class="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg">
          Confirmar y Salir
        </button>
      </div>
    </div>
  </div>

  <!-- Modal: Asignar nuevo l√≠der antes de salir -->
  <div *ngIf="showPromoteModal" 
       class="fixed inset-0 z-50 flex items-center justify-center bg-black/40"
       (click)="closePromoteModal()">
    <div class="bg-white w-[520px] max-w-[95vw] rounded-2xl shadow-xl p-6"
         (click)="$event.stopPropagation()">
      <h3 class="text-xl font-bold text-gray-900 mb-4">Asignar Nuevo L√≠der</h3>
      
      <p class="text-gray-600 mb-4">
        Eres el √∫nico l√≠der del proyecto. Debes asignar un nuevo l√≠der antes de salir.
      </p>

      <div class="space-y-3 mb-6 max-h-60 overflow-y-auto">
        <label class="block text-sm font-medium text-gray-700 mb-2">Selecciona el nuevo l√≠der:</label>
        
        <div *ngFor="let member of availableMembersForPromotion" 
             class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:border-cyan-500 transition"
             [class.border-cyan-500]="selectedNewLeader === member.id_usuario"
             [class.bg-cyan-50]="selectedNewLeader === member.id_usuario"
             (click)="selectedNewLeader = member.id_usuario">
          <input 
            type="radio"
            [checked]="selectedNewLeader === member.id_usuario"
            (change)="selectedNewLeader = member.id_usuario"
            class="w-4 h-4 text-cyan-600">
          
          <div class="w-10 h-10 bg-cyan-500 text-white rounded-full flex items-center justify-center font-semibold">
            {{ member.nombre.charAt(0).toUpperCase() }}
          </div>
          
          <div class="flex-1">
            <p class="font-medium text-gray-900">{{ member.nombre }}</p>
            <p class="text-sm text-gray-500">{{ member.email }}</p>
          </div>
        </div>

        <div *ngIf="availableMembersForPromotion.length === 0" 
             class="text-center py-4 text-gray-500">
          No hay miembros disponibles. Debes agregar m√°s miembros primero.
        </div>
      </div>

      <div class="flex justify-end gap-3">
        <button 
          type="button"
          (click)="closePromoteModal()"
          class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">
          Cancelar
        </button>
        <button 
          type="button"
          (click)="promoteAndLeave()"
          [disabled]="!selectedNewLeader"
          class="px-4 py-2 bg-cyan-500 hover:bg-cyan-600 text-white rounded-lg disabled:opacity-50">
          Asignar y Salir
        </button>
      </div>
    </div>
  </div>
</div>